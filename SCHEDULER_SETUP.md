# üïê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ Scheduler

Scheduler –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑—ã –ø–æ –ø–æ–¥–ø–∏—Å–∫–∞–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.

## üìã –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Scheduler:

1. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00 —É—Ç—Ä–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
2. –°–º–æ—Ç—Ä–∏—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–ø–Ω, —Å—Ä, –ø—Ç = "1,3,5")  
3. –°–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. –°–ø–∏—Å—ã–≤–∞–µ—Ç –≤—ã–Ω–æ—Å—ã –∏–∑ –±–∞–ª–∞–Ω—Å–∞
5. –£–≤–µ–¥–æ–º–ª—è–µ—Ç –∫—É—Ä—å–µ—Ä–æ–≤
6. –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∫–æ–≥–¥–∞ –≤—ã–Ω–æ—Å—ã –∑–∞–∫–æ–Ω—á–∞—Ç—Å—è

---

## üöÄ –í–∞—Ä–∏–∞–Ω—Ç 1: Railway Cron Job (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π Service –Ω–∞ Railway

1. –û—Ç–∫—Ä–æ–π –ø—Ä–æ–µ–∫—Ç –Ω–∞ Railway
2. –ù–∞–∂–º–∏ **"New Service"** ‚Üí **"Empty Service"**
3. –ù–∞–∑–æ–≤–∏: `ya-uberu-scheduler`

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å

1. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö service:
   - **Start Command:** `python cron.py`
   - **Build Command:** –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ image —á—Ç–æ –∏ backend)

2. –í **Settings** ‚Üí **Deploy Triggers**:
   - **Cron Schedule:** `0 6 * * *` (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00 UTC)
   
3. –ü–æ–¥–∫–ª—é—á–∏ —Ç–µ –∂–µ **Environment Variables** —á—Ç–æ –∏ –≤ backend:
   - `DATABASE_URL`
   - `TELEGRAM_BOT_TOKEN`
   - `TELEGRAM_COURIER_BOT_TOKEN`
   - `ADMIN_TELEGRAM_IDS`

### –®–∞–≥ 3: Deploy

Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å cron –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00.

---

## üåê –í–∞—Ä–∏–∞–Ω—Ç 2: –í–Ω–µ—à–Ω–∏–π Cron (–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)

–ò—Å–ø–æ–ª—å–∑—É–π —Å–µ—Ä–≤–∏—Å —Ç–∏–ø–∞ [cron-job.org](https://cron-job.org) –∏–ª–∏ GitHub Actions.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞:

1. **URL:** `https://–≤–∞—à-backend.railway.app/api/admin/scheduler/run`
2. **Method:** POST
3. **Schedule:** `0 6 * * *` (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00)
4. **Headers:** (–Ω–µ –Ω—É–∂–Ω—ã, endpoint –ø—É–±–ª–∏—á–Ω—ã–π)

---

## üß™ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è):

### –ß–µ—Ä–µ–∑ API:
```bash
curl -X POST https://–≤–∞—à-backend.railway.app/api/admin/scheduler/run
```

### –ß–µ—Ä–µ–∑ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:
–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å Scheduler" –≤ –∞–¥–º–∏–Ω–∫–µ.

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤ Railway –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
2. –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏:
   ```
   [SCHEDULER] Found X active subscriptions
   [SCHEDULER] Created order for subscription Y, user Z
   ```
3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∑–∞–∫–∞–∑—ã –ø–æ—è–≤–∏–ª–∏—Å—å –≤ –ë–î –∏ –±–∞–ª–∞–Ω—Å —Å–ø–∏—Å–∞–ª—Å—è

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

- **–õ–æ–≥–∏:** Railway ‚Üí Service ‚Üí Deployments ‚Üí Logs
- **–ë–∞–∑–∞:** –ü—Ä–æ–≤–µ—Ä—è–π —Ç–∞–±–ª–∏—Ü—É `orders` –∏ `balance_transactions`
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** –ö—É—Ä—å–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

---

## üêõ Troubleshooting:

**Scheduler –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑—ã?**
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ `is_active = true` –≤ –ø–æ–¥–ø–∏—Å–∫–∞—Ö
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ `used_credits < total_credits`
- –ü—Ä–æ–≤–µ—Ä—å `schedule_days` (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "1,3,5" –¥–ª—è –ø–Ω/—Å—Ä/–ø—Ç)

**–ë–∞–ª–∞–Ω—Å –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è?**
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `balances`
- –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ scheduler

**–ö—É—Ä—å–µ—Ä—ã –Ω–µ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?**
- –ü—Ä–æ–≤–µ—Ä—å `TELEGRAM_COURIER_BOT_TOKEN` –≤ env vars
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∫—É—Ä—å–µ—Ä—ã –∞–∫—Ç–∏–≤–Ω—ã (`is_active = true`)

